# MagDB_FootMount建立磁场指纹库
## 1.简介
&emsp;&emsp;本文档用于解释如何使用FootMount模块和智能手机构建磁场指纹库。其中FootMount为脚绑IMU模块，通过采集足部惯导数据，以Foot-INS结合少量控制点解算高精度的修正位置信息，辅助手机内置IMU和磁力计构建磁场指纹库。

## 2.设备说明
&emsp;&emsp;FootMount建立磁场指纹库包括使用Foot-INS结合少量控制点生成精度较高的相对坐标，结合手机内置的加速度计、陀螺仪和磁力计，生成磁场指纹库。相较于GoSLAM建立磁场指纹库，FootMonut构建磁场指纹库需要在量测区域构建少量的控制点以抑制Foot-INS的发散。

&emsp;&emsp;控制FootMount模块的软件为i2NavFootMount。该软件可以控制模块和智能手机自己的传感器，通过蓝牙将手机和FootMount模块进行连接，采集模块数据的同时采集手机自身传感器数据。该软件分为两块

## 3.数据采集
### 3.1 磁场数据库构建原理
&emsp;&emsp;磁场指纹库的构建是通过一定测量手段构建磁场特征与地理坐标之间的关联性，即包括两部分：磁场特征测量和位置坐标测量两部分。

**（1）磁场特征测量**

&emsp;&emsp;环境磁场特征是通过智能手机内置的磁力计进行量测，但是由于手机中内置的磁力计传感器质量差，存在很大的零位偏置，因此需要对磁力计进行零偏的扣除。现阶段，磁力计零偏扣除手段有两种：椭球拟合和在线标定。

&emsp;&emsp;椭球拟合是指在数据采集之前，采集一组手机传感器的数据，这组传感器数据需要以用户手持手机以特定的姿势运动（即手持手机绕“8”字形转动），确保磁力计能够转动到各个方向，能有很好的几何构型。之后利用椭球拟合算法进行解算，解算出来的中心偏置即可近似看作磁力计的零偏值。之后再使用的过程中，将磁力计扣除这个零偏。

&emsp;&emsp;在线标定是指在数据采集的过程中，通过一种特定算法，在线估计磁力计零偏，以达到不需要使用特定动作即可完成磁力计的校准工作。在一般的室内环境或者半遮挡的室外环境，可以合理的认为局部区域的磁场干扰的平均值为零，即可认为在测试区域内观测到的环境磁场矢量的平均值等于地磁场矢量。且磁力计零偏在短时间内不会发生变化，因此观测到的磁场和地磁场矢量之间的关系可以描述为

$$
\begin{align}
\pmb{M^n} \approx \frac{1}{k} \sum_{i=1}^k{\pmb{C}_{b,i}^n(\tilde{\pmb{M}}_i^b-\pmb{b}_m)} 
\end{align}
$$

式中，$\pmb{M}^n$为$n$系下的三维磁场矢量，可通过查询国际地磁参考场（International Geomagnetic Reference Field，IGRF）获得；$\widetilde{\pmb{M}}_i^b$为磁力计的原始观测值；$\pmb{b}_m$为磁力计的零偏；$\pmb{C}_{b,i}^n$为$b$系到$n$系的方向余弦矩阵；$k$为磁力计的观测数量。之后，根据迭代求解水平次海沧分量，可解算得到环境磁场特征向量。具体方法如下所示：
- 磁场矢量的初始值可根据一段时间窗口的磁场观测值的平均值解算得到

    $$
    \begin{align}
    \pmb{M}_0^n \approx \frac{1}{k} \sum_{i=1}^k{\pmb{C}_{b,i}^n\tilde{\pmb{M}}_i^b} 
    \end{align}
    $$

- 基于磁力计零偏在短时间内不会改变的假设，磁力计零偏可以计算为

    $$
    \begin{align}
    \pmb{b}_{m,1} \approx \frac{1}{k} \sum_{1=1}^k{(\tilde{\pmb{M}}_i^b-\pmb{C}_{n,i}^b\pmb{M}_0^n)} 
    \end{align}
    $$
    式中,“1”为迭代次数。

- 将$b_{m,1}$带入公式4.1，即可计算得到磁场矢量$\pmb{M}_1^n$

- 重复第2步和第3步，直到满足

    $$ 
    \begin{align}
    \|\pmb{M}_{i-1}^n-\pmb{M}_i^n\| < \gamma 
    \end{align}
    $$

    式中，$\gamma$为确定算法收敛的阈值，$i$是迭代次数。$n$系下单个位置的MFS可描述为

    $$
    \begin{align}
    \hat{\pmb{M}}_i^n = \pmb{C}_{b,i}^n(\tilde{\pmb{M}}_i^b-\hat{\pmb{b}}_m)
    \end{align}
    $$

    式中,$\hat{\pmb{M}}_i^n$为估计的磁场矢量，$\hat{\pmb{b}}_m$为校准后的磁力计零偏。

**（2）位置坐标测量**

### 3.2 数据采集流程

**（1）环境探测及草图绘制**

&emsp;&emsp;观察将要构造的磁场指纹库周围的环境信息，绘制出环境草图，并在草图上标明要布设的控制点信息。同时规划路线，构造栅格数据库网

**（2）稀疏控制点位置量测**

**（3）仪器连接**

**（4）数据采集开始**

**（5）数据采集**

**（6）数据采集结束**

### 3.3 数据文件说明

**（1）手机传感器数据文件夹**

**（2）FootMount模块输出数据**

## 4.数据处理
### 4.1 Foot-INS解算获取高精度轨迹

&emsp;&emsp;FootMount采集的数据通过结合少量控制点，利用FootINS后处理软件，解算得到相对精度较高的位置轨迹。FootINS-后处理软件为Windows版本。Foot-INS后处理的软件使用步骤如下：
   
   1. 先确定硬件版本，修改硬件版本
   2. 导入惯导数据，此惯导数据为脚绑IMU模块采集的数据
   3. 导入稀疏控制点坐标，控制点坐标的格式为（时间、纬度、经度、高程），其中纬度和经度的单位为deg
   4. 导入时间参考文件，即数据文件夹中的imupos.txt文件

&emsp;&emsp;同时该软件可以进行批量处理。


### 4.2 数据处理程序

### 4.3 数据处理结果
